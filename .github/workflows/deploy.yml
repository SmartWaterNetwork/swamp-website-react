name: SWAMP Deployment Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4
        with:
          # Mantiene la carpeta limpia antes de la descarga
          clean: true

      - name: Instalar y Construir
        shell: cmd
        run: |
          echo === Trabajando en el Workspace del Runner ===
          :: Instalamos y generamos la carpeta 'dist' aquí mismo
          call npm install
          call npm run build

      - name: Despliegue con PM2
        shell: cmd
        run: |
          echo === Actualizando PM2 ===
          
          :: Borramos la instancia previa para evitar conflictos de puerto
          call pm2 delete swamp-website || echo "Nada que borrar"
          
          :: Iniciamos usando la ruta dinamica de GitHub Workspace
          :: Esto apunta a C:\actions-runner\_work\swamp-website-react\swamp-website-react\dist
          call pm2 start "%SWAMP_SERVE_JS%" --name "swamp-website" -- -s "%GITHUB_WORKSPACE%\dist" -l 3000
          
          :: Guardamos para que el proceso sea persistente
          call pm2 save
          
          :: Verificamos que el estado sea 'online'
          call pm2 list