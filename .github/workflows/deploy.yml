name: SWAMP Deployment Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    # Utilizamos la variable de entorno del sistema para definir la ruta de trabajo
    # Esto mantiene la privacidad de tus rutas en GitHub
    defaults:
      run:
        working-directory: ${{ env.SWAMP_APP_PATH }}

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4
        with:
          # El punto indica que descargue el contenido en el directorio actual definido arriba
          path: .
          # Mantiene la integridad eliminando archivos que ya no existen en el repositorio
          clean: true

      - name: Instalar dependencias
        # 'call' es vital para que el Runner no se cierre tras ejecutar npm en Windows
        run: call npm install

      - name: Construir aplicación (Build)
        run: call npm run build

      - name: Despliegue con PM2
        shell: cmd
        run: |
          echo === Actualizando PM2 en %SWAMP_APP_PATH% ===
          
          :: Limpiar instancia previa para evitar conflictos de archivos bloqueados
          call pm2 delete swamp-website || echo "Nada que borrar"
          
          :: Iniciar la app apuntando a la carpeta dist recién generada
          :: Esto asegura que el estado pase a 'online' con un nuevo PID
          call pm2 start "%SWAMP_SERVE_JS%" --name "swamp-website" -- -s "%SWAMP_APP_PATH%\dist" -l 3000
          
          :: Guardar configuración para persistencia tras reinicios del servidor
          call pm2 save
          
          :: Mostrar tabla de procesos final en el log de GitHub
          call pm2 list